#!/bin/bash
# Unified backup script using restic
# Reads configuration from RESTIC_BACKUP_RESTIC_BACKUP_CONFIG_FILE (default: /etc/digitalocean/backup.yaml)

set -e

source /etc/s6-overlay/lib/env-utils.sh
source_env_prefix RESTIC_

QUIET=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --quiet|-q)
      QUIET=1
      shift
      ;;
    *)
      shift
      ;;
  esac
done

log() {
  [ -z "$QUIET" ] && echo "[backup] $1"
}

# Check if persistence is configured
if [ -z "$RESTIC_REPOSITORY" ] || [ -z "$RESTIC_PASSWORD" ]; then
  log "Persistence not configured, skipping backup"
  exit 0
fi

# AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY are loaded from RESTIC_ prefix (set by 05-setup-restic)
if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
  log "ERROR: AWS_ACCESS_KEY_ID or AWS_SECRET_ACCESS_KEY not set (check RESTIC_ env setup)"
  exit 1
fi

# Check if config exists
if [ ! -f "$RESTIC_BACKUP_CONFIG_FILE" ]; then
  log "Config file not found: $RESTIC_BACKUP_CONFIG_FILE"
  exit 1
fi

# Save dpkg selections before backup (for restore-packages)
DPKG_SELECTIONS="/etc/openclaw/dpkg-selections"
mkdir -p "$(dirname "$DPKG_SELECTIONS")"
dpkg --get-selections > "$DPKG_SELECTIONS" 2>/dev/null || true

# Get number of paths to backup
PATH_COUNT=$(yq -r '.paths | length' "$RESTIC_BACKUP_CONFIG_FILE")

if [ "$PATH_COUNT" -eq 0 ]; then
  log "No paths configured for backup"
  exit 0
fi

log "Starting backup of $PATH_COUNT paths..."

# Build restic backup command for each path
for i in $(seq 0 $((PATH_COUNT - 1))); do
  BACKUP_PATH=$(yq -r ".paths[$i].path" "$RESTIC_BACKUP_CONFIG_FILE")

  # Skip if path doesn't exist
  if [ ! -e "$BACKUP_PATH" ]; then
    log "Path does not exist, skipping: $BACKUP_PATH"
    continue
  fi

  # Build exclude arguments
  EXCLUDE_ARGS=""
  EXCLUDE_COUNT=$(yq -r ".paths[$i].exclude | length // 0" "$RESTIC_BACKUP_CONFIG_FILE")

  for j in $(seq 0 $((EXCLUDE_COUNT - 1))); do
    PATTERN=$(yq -r ".paths[$i].exclude[$j]" "$RESTIC_BACKUP_CONFIG_FILE")
    EXCLUDE_ARGS="$EXCLUDE_ARGS --exclude=$PATTERN"
  done

  log "Backing up: $BACKUP_PATH"

  # Run restic backup
  if restic backup $EXCLUDE_ARGS "$BACKUP_PATH" 2>&1 | grep -v "^unchanged\|^modified\|^new" || true; then
    log "Completed: $BACKUP_PATH"
  else
    log "Warning: Backup may have had issues for $BACKUP_PATH"
  fi
done

log "Backup complete"

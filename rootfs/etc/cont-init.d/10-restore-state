#!/command/with-contenv bash
# Restore state paths from restic backup
source /etc/s6-overlay/lib/env-utils.sh

# Load RESTIC_ vars
source_env_prefix RESTIC_

# Load OPENCLAW_ vars (for migration URL)
source_env_prefix OPENCLAW_

# MIGRATION: Check for migration data download URL
if [ -n "$OPENCLAW_MIGRATION_URL" ] && [ ! -f "/data/.openclaw/workspace/SOUL.md" ]; then
  echo "[restore-state] Downloading migration data from: $OPENCLAW_MIGRATION_URL"
  mkdir -p /data

  if curl -fsSL "$OPENCLAW_MIGRATION_URL" -o /tmp/migration.tar.gz; then
    echo "[restore-state] Extracting migration data..."
    tar xzf /tmp/migration.tar.gz -C /data/

    # Fix ownership
    chown -R openclaw:openclaw /data/.openclaw 2>/dev/null || true
    chown -R openclaw:openclaw /data/.meeting-chief 2>/dev/null || true

    rm -f /tmp/migration.tar.gz
    echo "[restore-state] Migration data extraction complete"
  else
    echo "[restore-state] WARNING: Failed to download migration data"
  fi
fi

# MEETING-CHIEF: Download SQLite database from Spaces
# Only download if file doesn't exist or is empty (first boot)
MEETING_CHIEF_DB_PATH="/data/.meeting-chief/data/meetings.db"
MEETING_CHIEF_DB_URL="https://openclaw-backup.tor1.digitaloceanspaces.com/migration/meetings.db"

if [ ! -f "$MEETING_CHIEF_DB_PATH" ] || [ ! -s "$MEETING_CHIEF_DB_PATH" ]; then
  echo "[restore-state] Downloading Meeting-Chief database from Spaces..."
  mkdir -p "$(dirname "$MEETING_CHIEF_DB_PATH")"

  if curl -fsSL "$MEETING_CHIEF_DB_URL" -o /tmp/meetings.db.tmp; then
    # Verify file size is reasonable (should be ~589 MB)
    FILE_SIZE=$(stat -f%z /tmp/meetings.db.tmp 2>/dev/null || stat -c%s /tmp/meetings.db.tmp 2>/dev/null || echo "0")
    if [ "$FILE_SIZE" -gt 100000000 ]; then
      mv /tmp/meetings.db.tmp "$MEETING_CHIEF_DB_PATH"
      chown openclaw:openclaw "$MEETING_CHIEF_DB_PATH"
      DB_SIZE_MB=$(du -h "$MEETING_CHIEF_DB_PATH" | cut -f1)
      echo "[restore-state] Meeting-Chief database restored ($DB_SIZE_MB)"
    else
      echo "[restore-state] ERROR: Downloaded file too small ($FILE_SIZE bytes), aborting restore"
      rm -f /tmp/meetings.db.tmp
    fi
  else
    echo "[restore-state] WARNING: Failed to download Meeting-Chief database from Spaces"
  fi
fi

# Check if persistence is configured
if [ -z "$RESTIC_REPOSITORY" ] || [ -z "$RESTIC_PASSWORD" ]; then
  echo "[restore-state] Persistence not configured, skipping"
  exit 0
fi

# Check if config exists
if [ ! -f "$RESTIC_BACKUP_CONFIG_FILE" ]; then
  echo "[restore-state] Config file not found: $RESTIC_BACKUP_CONFIG_FILE"
  exit 1
fi

# Check if repository has any snapshots
if ! restic snapshots --latest 1 2>/dev/null | grep -q 'ID'; then
  echo "[restore-state] No snapshots found in repository, skipping"
  exit 0
fi

# Restore all paths in order (config has /etc first)
PATH_COUNT=$(yq -r '.paths | length' "$RESTIC_BACKUP_CONFIG_FILE")

if [ "$PATH_COUNT" -eq 0 ]; then
  echo "[restore-state] No paths configured for restore"
  exit 0
fi

echo "[restore-state] Restoring $PATH_COUNT paths..."

for i in $(seq 0 $((PATH_COUNT - 1))); do
  RESTORE_PATH=$(yq -r ".paths[$i].path" "$RESTIC_BACKUP_CONFIG_FILE")

  # Ensure parent directory exists
  mkdir -p "$(dirname "$RESTORE_PATH")"

  # Find latest snapshot for this specific path
  SNAPSHOT_ID=$(restic snapshots --path "$RESTORE_PATH" --latest 1 --json 2>/dev/null | jq -r '.[0].id // empty')

  if [ -z "$SNAPSHOT_ID" ]; then
    echo "[restore-state] No snapshot found for $RESTORE_PATH, skipping"
    continue
  fi

  echo "[restore-state] Restoring: $RESTORE_PATH (snapshot $SNAPSHOT_ID)"

  # Run restic restore from the snapshot that contains this path
  if restic restore "$SNAPSHOT_ID" --target / --include "$RESTORE_PATH" 2>&1; then
    echo "[restore-state] Completed: $RESTORE_PATH"
  else
    echo "[restore-state] Warning: Restore may have had issues for $RESTORE_PATH (continuing)"
  fi
done

# Permissions applied via /etc/digitalocean/permissions.yaml

echo "[restore-state] Restore complete"
